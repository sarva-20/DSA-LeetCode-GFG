name: Auto-Organize LeetCode Solutions
on:
  push:
    branches:
      - main
  workflow_dispatch:

# Remove concurrency lock to allow multiple runs
# But add better conflict handling instead

jobs:
  organize:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0
      
      - name: Move LeetCode solutions to Leetcode folder
        run: |
          # Create Leetcode folder if it doesn't exist
          mkdir -p Leetcode
          
          # Track if we made any changes
          changes_made=false
          
          # Find all folders starting with numbers (LeetCode problem format)
          for dir in [0-9]*-*/; do
            # Remove trailing slash
            dir_name="${dir%/}"
            
            if [ -d "$dir_name" ]; then
              echo "Found LeetCode problem folder: $dir_name"
              
              # Get the latest commit message
              commit_msg=$(git log -1 --pretty=%B)
              echo "Commit message: $commit_msg"
              
              # Extract time and space from commit message
              time_value=""
              space_value=""
              
              if [[ "$commit_msg" =~ Time:\ ([0-9]+)\ ms.*Space:\ ([0-9.]+)\ MB ]]; then
                time_value="${BASH_REMATCH[1]}ms"
                space_value="${BASH_REMATCH[2]}MB"
                echo "  -> Extracted performance: Time=${time_value}, Space=${space_value}"
              fi
              
              # Create target directory structure
              mkdir -p "Leetcode/$dir_name"
              
              # Determine solution folder name
              if [ -n "$time_value" ] && [ -n "$space_value" ]; then
                solution_folder="solution-${time_value}-${space_value}"
              else
                timestamp=$(date +"%Y-%m-%d-%H%M%S")
                solution_folder="solution-${timestamp}"
                echo "  -> Could not extract performance, using timestamp"
              fi
              
              target_path="Leetcode/$dir_name/$solution_folder"
              
              # If this exact solution already exists, add a suffix
              counter=1
              original_target="$target_path"
              while [ -d "$target_path" ]; do
                target_path="${original_target}-v${counter}"
                counter=$((counter + 1))
              done
              
              echo "  -> Moving to $target_path"
              
              # Create the solution directory and move contents
              mkdir -p "$target_path"
              mv "$dir_name"/* "$target_path/" 2>/dev/null || true
              rmdir "$dir_name" 2>/dev/null || true
              
              changes_made=true
            fi
          done
          
          if [ "$changes_made" = false ]; then
            echo "No LeetCode folders found in root directory"
          fi
          
      - name: Commit and push changes
        run: |
          git config user.name "sarva-20"
          git config user.email "tarshuponns@gmail.com"
          
          # Stage all changes
          git add -A
          
          # Check if there are changes to commit
          if ! git diff --staged --quiet; then
            git commit -m "ü§ñ Auto-organize: Archive LeetCode solution with performance metrics"
            
            # Advanced retry with conflict resolution
            max_retries=5
            attempt=1
            
            while [ $attempt -le $max_retries ]; do
              echo "üì§ Push attempt $attempt of $max_retries..."
              
              if git push origin main; then
                echo "‚úÖ Push successful!"
                break
              else
                echo "‚ö†Ô∏è Push failed, fetching latest changes..."
                sleep 3
                
                # Fetch latest without merging
                git fetch origin main
                
                # Try to merge with our strategy preferred
                if git merge origin/main --no-edit --strategy-option=ours; then
                  echo "‚úÖ Merge successful, retrying push..."
                else
                  echo "‚ö†Ô∏è Merge conflict, resolving with our version..."
                  # Accept all our changes in conflict
                  git checkout --ours .
                  git add -A
                  git commit --no-edit || true
                fi
                
                attempt=$((attempt + 1))
              fi
            done
            
            if [ $attempt -gt $max_retries ]; then
              echo "‚ùå Failed to push after $max_retries attempts"
              echo "‚ÑπÔ∏è This is okay - another workflow might have already organized the files"
              exit 0  # Exit gracefully instead of failing
            fi
            
          else
            echo "No changes to commit"
          fi
