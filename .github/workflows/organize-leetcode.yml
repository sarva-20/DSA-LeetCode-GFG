name: Auto-Organize LeetCode Solutions
on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  organize:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0
      
      - name: Move LeetCode solutions to Leetcode folder
        run: |
          # Create Leetcode folder if it doesn't exist
          mkdir -p Leetcode
          
          # Find all folders starting with numbers (LeetCode problem format)
          for dir in [0-9]*-*/; do
            dir_name="${dir%/}"
            
            if [ -d "$dir_name" ]; then
              echo "Found LeetCode problem folder: $dir_name"
              
              # Get commit message for performance metrics
              commit_msg=$(git log -1 --pretty=%B)
              
              # Extract time and space
              time_value=""
              space_value=""
              
              if [[ "$commit_msg" =~ Time:\ ([0-9]+)\ ms.*Space:\ ([0-9.]+)\ MB ]]; then
                time_value="${BASH_REMATCH[1]}ms"
                space_value="${BASH_REMATCH[2]}MB"
              fi
              
              # Create target structure
              mkdir -p "Leetcode/$dir_name"
              
              # Determine solution folder name
              if [ -n "$time_value" ] && [ -n "$space_value" ]; then
                solution_folder="solution-${time_value}-${space_value}"
              else
                timestamp=$(date +"%Y%m%d-%H%M%S")
                solution_folder="solution-${timestamp}"
              fi
              
              target_path="Leetcode/$dir_name/$solution_folder"
              
              # Handle existing solutions
              counter=1
              original_target="$target_path"
              while [ -d "$target_path" ]; do
                target_path="${original_target}-v${counter}"
                counter=$((counter + 1))
              done
              
              echo "Moving to $target_path"
              
              # Move contents
              mkdir -p "$target_path"
              mv "$dir_name"/* "$target_path/" 2>/dev/null || true
              rmdir "$dir_name" 2>/dev/null || true
            fi
          done
          
      - name: Commit and push changes
        run: |
          git config user.name "sarva-20"
          git config user.email "tarshuponns@gmail.com"
          
          git add -A
          
          if ! git diff --staged --quiet; then
            git commit -m "ü§ñ Auto-organize: Archive LeetCode solution"
            
            # Simple retry with force pull
            for i in {1..5}; do
              echo "Push attempt $i..."
              
              if git push origin main; then
                echo "‚úÖ Success!"
                exit 0
              fi
              
              echo "Retrying with fresh pull..."
              sleep 2
              
              # Reset and pull fresh
              git reset --soft HEAD~1
              git fetch origin main
              git reset --hard origin/main
              
              # Re-apply our changes
              for dir in [0-9]*-*/; do
                dir_name="${dir%/}"
                if [ -d "$dir_name" ]; then
                  commit_msg=$(git log -1 --pretty=%B)
                  
                  time_value=""
                  space_value=""
                  if [[ "$commit_msg" =~ Time:\ ([0-9]+)\ ms.*Space:\ ([0-9.]+)\ MB ]]; then
                    time_value="${BASH_REMATCH[1]}ms"
                    space_value="${BASH_REMATCH[2]}MB"
                  fi
                  
                  mkdir -p "Leetcode/$dir_name"
                  
                  if [ -n "$time_value" ] && [ -n "$space_value" ]; then
                    solution_folder="solution-${time_value}-${space_value}"
                  else
                    solution_folder="solution-$(date +%Y%m%d-%H%M%S)"
                  fi
                  
                  target_path="Leetcode/$dir_name/$solution_folder"
                  counter=1
                  original_target="$target_path"
                  while [ -d "$target_path" ]; do
                    target_path="${original_target}-v${counter}"
                    counter=$((counter + 1))
                  done
                  
                  mkdir -p "$target_path"
                  mv "$dir_name"/* "$target_path/" 2>/dev/null || true
                  rmdir "$dir_name" 2>/dev/null || true
                fi
              done
              
              git add -A
              git commit -m "ü§ñ Auto-organize: Archive LeetCode solution" || exit 0
            done
            
            echo "‚ö†Ô∏è Could not push after 5 attempts, but that's okay"
            exit 0
          fi
